@*@using Models.Slider
@model string;
@{
    ViewData["Title"] = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

@section Styles{
    <link href="~/css/form.css" rel="stylesheet" />
    <link href="~/css/data-grid.css" rel="stylesheet" />
    <link href="~/lib/cropperjs/cropper.min.css" rel="stylesheet" />
    <link href="~/css/slider.css" rel="stylesheet" />
    <link href="~/lib/MD.BootstrapPersianDateTimePicker/dist/jquery.md.bootstrap.datetimepicker.style.css" rel="stylesheet" />
    <link href="~/lib/bootstrap-colorpicker/dist/css/bootstrap-colorpicker.css" rel="stylesheet" />
}


<div class="headPage text-right">
    <h5>@($"اسلایدهای {Model}")</h5>

    <a class="action-head add open" data-toggle="collapse" href="#add">
        <i class="fa fa-plus" aria-hidden="true"></i>
    </a>

</div>

<div id="add" class="box-container collapse">
    <div class="box-head">
        <i class="fa fa-dot-circle-o" aria-hidden="true"></i>
        <span>اسلاید</span>
    </div>
    <div class="box-body ">
        <form id="addSlide" class="sm" asp-action="AddSlide" asp-controller="Slider" method="post" autocomplete="off" asp-antiforgery="true">
            <div class="form-row text-right ">
                <div class=" col-md-12">
                    <div class="row">
                        <div class="form-group col-md-6 col-lg-3">
                            <div id="ImageWrap" class="" style="background: #f3f3f3;padding: 10px 10px;">
                                <span class="field-validation-error" data-val-result="Pic"></span>
                                <div class="ImageWrapper">
                                    <img src="~/images/blank.png" />
                                </div>
                                <label class="custom-upload text-center" for="Image" style="width: 100%;padding: 2px 10px;">
                                    <input type="file" accept="image/x-png,image/jpeg" name="Image" id="Image" onchange="CropperShow(this)" />تصویر اسلاید
                                </label>
                                <span class="field-validation-error" data-val-result="ImageUrl"></span>
                            </div>
                        </div>
                        <input type="hidden" class="form-control" id="Id" name="Id" placeholder=" ">
                        <div class="row col-md-6 col-lg-9">
                            <div class="form-group col-md-12 col-lg-4">
                                <label for="Title">عنوان اسلاید</label>
                                <input type="text" class="form-control" id="Title" name="Title" placeholder=" ">
                                <span class="field-validation-error" data-val-result="Title"></span>
                            </div>

                            <div id="calenderStart" class="form-group col-md-12 col-lg-4">
                                <label for="StartDate"> شروع تاریخ انتشار </label>
                                <div class="input-group">
                                    <input type="text" name="StartDate" id="StartDate" class="form-control" placeholder="" aria-label="dateTime" aria-describedby="date" readonly="">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text cursor-pointer" data-mdpersiandatetimepicker="" data-mdpersiandatetimepicker-group="rangeSelector"><i class="fa fa-calendar"></i></span>
                                    </div>
                                    <input type="hidden" id="StartDateHide" />
                                </div>
                                <span class="field-validation-error" data-val-result="StartDate"></span>
                            </div>
                            <div id="calenderEnd" class="form-group col-md-12 col-lg-4">
                                <label for="ExpireDate"> پایان تاریخ انتشار </label>
                                <div class="input-group">
                                    <input type="text" name="ExpireDate" id="ExpireDate" class="form-control" placeholder="" aria-label="dateTime" aria-describedby="date">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text cursor-pointer" data-mdpersiandatetimepicker="" data-mdpersiandatetimepicker-group="rangeSelector"><i class="fa fa-calendar"></i></span>
                                    </div>
                                    <input type="hidden" id="ExpireDateHide" />
                                </div>
                                <span class="field-validation-error" data-val-result="ExpireDate"></span>
                            </div>
                            <div class="form-group col-md-12 col-lg-4">
                                <label for="ColoredBackground">رنگ پس زمینه</label>
                                <input type="text" class="form-control" id="ColoredBackground" name="ColoredBackground" placeholder=" ">
                                <span class="field-validation-error" data-val-result="ColoredBackground"></span>
                            </div>
                            <div class="form-group col-md-12 col-lg-4">
                                <label for="ImageFit">Image Fit</label>
                                <select name="ImageFit" id="ImageFit" class="form-control" asp-items="Html.GetEnumSelectList<ImageFit>()"></select>
                                <span class="field-validation-error" data-val-result="ImageFit"></span>
                            </div>
                            <div class="form-group col-md-12 col-lg-4">
                                <label for="TransActionType">Transaction Type</label>
                                <select name="TransActionType" id="TransActionType" class="form-control" asp-items="Html.GetEnumSelectList<TransActionType>()"></select>
                                <span class="field-validation-error" data-val-result="TransActionType"></span>
                            </div>
                            <div class="form-group col-md-12 col-lg-4">
                                <label for="Link">لینک</label>
                                <input type="text" class="form-control" id="Link" name="Link" placeholder=" ">
                                <span class="field-validation-error" data-val-result="Link"></span>
                            </div>
                            <div class="form-group col-md-12 col-lg-4">
                                <label for="Target">نمایش لینک</label>
                                <select name="Target" id="Target" class="form-control" asp-items="Html.GetEnumSelectList<Target>()"></select>
                                <span class="field-validation-error" data-val-result="Target"></span>
                            </div>
                            <div class="form-group col-md-12 col-lg-4">
                                <label for="Alt">تگ Alt</label>
                                <input type="text" class="form-control" id="Alt" name="Alt" placeholder=" ">
                                <span class="field-validation-error" data-val-result="Alt"></span>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-success btn-xs">
                <i class="fa fa-check" aria-hidden="true"></i>&nbspتایید
            </button>
        </form>
    </div>
</div>

<div class="table">
    <div class="table-head d-none d-lg-block">
        <div class="table-row">
            <div class="row m-0">
                <div class="table-col col-md-1">
                    <span>ردیف</span>
                </div>
                <div class="table-col col-md-1">
                    <span>تصویر</span>
                </div>
                <div class="table-col col-md-2">
                    <span>عنوان</span>
                </div>
                <div class="table-col col-md-1">
                    <span>رنگ زمینه</span>
                </div>
                <div class="table-col col-md-1">
                    <span> لینک </span>
                </div>
                <div class="table-col col-md-1">
                    <span>تاریخ انتشار </span>
                </div>
                <div class="table-col col-md-1">
                    <span>تاریخ انقضا</span>
                </div>
                <div class="table-col col-md-1">
                    <span>وضعیت</span>
                </div>
                <div class="table-col col-md-2">
                    <span></span>
                </div>
            </div>
        </div>
    </div>

    <div id="table" class="table-body">

    </div>
</div>


<!-- Modal -->
<div id="uploadModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-xl">
        <!-- Modal content-->
        <div class="modal-content">
            <a role="button" class="modal-close" data-dismiss="modal"></a>
            <div class="modal-header">
                <h6 class="modal-title"> برش عکس </h6>
            </div>
            <div class="modal-body" id="upload-modal-body">
                <div id="rowContainer" class="row">
                    <div id="container" class="col-md-6" style="height: 220px;">
                        <img class="img-fluid" hidden="hidden" id="blah" src="#" alt="your image" style="max-width: 100%; width: 356px; height: 100%; border: 1px solid black" />
                    </div>
                    <div id="resultCrop" class="col-md-6 text-center">

                    </div>
                </div>
            </div>

            <div class="modal-footer justify-content-center align-items-center">
                <div>
                    <button class="btn btn-success" id="send_pic" type="button" data-id="">تایید</button>
                    <button class="btn btn-primary" id="crop_button">برش</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal remove-->
<div id="removeModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <a role="button" class="modal-close" data-dismiss="modal"></a>
            <div class="modal-header">
                <h6 class="modal-title">حذف خبر </h6>
            </div>
            <div class="modal-body text-center">
                <p class="alert warning">آیا برای حذف اسلایدر اطمینان دارید؟</p>
                <button id="delete" type="button" class="btn btn-danger btn-sm btn-modal-body" data-dismiss="modal">حذف</button>
                <button type="button" class="btn btn-outline-danger btn-sm btn-modal-body" data-dismiss="modal" style="margin-left:5px">انصراف</button>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script src="~/lib/cropperjs/cropper.min.js"></script>
    <script src="~/js/cropper.js"></script>
    <script src="~/lib/MD.BootstrapPersianDateTimePicker/dist/jquery.md.bootstrap.datetimepicker.js"></script>
    <script src="~/lib/twbs-pagination/jquery.twbsPagination.js"></script>
    <script src="~/lib/bootstrap-colorpicker/dist/js/bootstrap-colorpicker.js"></script>

    <script>
        $('#ColoredBackground').colorpicker({ format: 'rgba' });
        var picSrc;
        var pageSize = 10;
        var $pagination = $('#pagination');
        var defaultOpts = {
            visiblePages: 5,
            first: "اولین",
            prev: "قبلی",
            next: "بعدی",
            last: "آخرین"
        };

        var aspectCropper = 0;

        function CropperShow(img) {
            readURL(img, aspectCropper);
        }

        $('#uploadModal').on('hidden.bs.modal',
            function () {
                cropper.destroy();
                document.getElementById("Image").value = "";
                $("#cropped_result").remove();
            });

        $(document).on("click",
            "#picRecord",
            function (e) {
                e.preventDefault();
                $("#uploadModal").modal("show");
            });

        $(document).on("click",
            "#send_pic",
            function () {
                var url = $("#pic").attr("src");
                var pic = '';
                picSrc = url;

                $(".ImageWrapper img").attr("src", picSrc);

                $('#uploadModal').modal("hide");
            });

        $('#calenderStart').MdPersianDateTimePicker({
            targetTextSelector: '#StartDate',
            targetDateSelector: '#StartDateHide',
            fromDate: true,
            enableTimePicker: true,
            groupId: 'rangeSelector',
        });
        $('#calenderEnd').MdPersianDateTimePicker({
            targetTextSelector: '#ExpireDate',
            targetDateSelector: '#ExpireDateHide',
            toDate: true,
            enableTimePicker: true,
            groupId: 'rangeSelector',
        });
    </script>

    <script>
        $(document).ready(function() {

            list();

            $("#addSlide").submit(function(e) {
                e.preventDefault();

                var spanErrorList = $('#addSlide span[data-val-result]');
                spanErrorList.html("");
                spanErrorList.parent().removeClass("has-error");

                var $inputs = $('#addSlide :input');
                var values = {};
                $inputs.each(function() {
                    values[this.name] = $(this).val();
                });

                values["ExpireDate"] = $("#ExpireDateHide").val();
                values["StartDate"] = $("#StartDateHide").val();
                values["SliderId"] = "@(ViewBag.SliderId)";
                values["ImageUrl"] = picSrc;

                if (values["Id"] === "") {
                    $.ajax({
                        url: "@Url.Action("AddSlide")",
                        type: 'Post',
                        data: values,
                        beforeSend: function() {
                            $("#loading").css("display", "block");
                        },
                        success: function(result) {
                            if (result.status === "success") {
                                list();
                                Swal.fire({
                                    type: 'success',
                                    title: result.message,
                                    confirmButtonText:
                                        '<i class="fa fa-thumbs-up"></i> متوجه شدم!',
                                });


                            } else if (result.status === "error") {
                                if (spanErrorList.length > 1) {
                                    spanErrorList.each(function() {
                                        $(this).html("");
                                        $(this).parent().removeClass("has-error");
                                    });
                                }

                                if (result.modelStateErrors !== null) {
                                    console.log(result);
                                    result.modelStateErrors.forEach(function(value, index) {
                                        $("#addSlide").find('[data-val-result=' + value.key + ']')
                                            .html(value.errorMessage);
                                        $("#addSlide").find('[data-val-result=' + value.key + ']').parent()
                                            .addClass("has-error");
                                    });
                                } else {
                                    Swal.fire({
                                        type: 'error',
                                        title: result.message,
                                        confirmButtonText:
                                            '<i class="fa fa-thumbs-up"></i> متوجه شدم!',
                                    });
                                }
                            }

                        },
                        error: function(xhr, ajaxOptions, thrownError) {

                        },
                        complete: function() {
                            $("#loading").css("display", "none");
                        }
                    });
                } else {
                    $.ajax({
                        url: "@Url.Action("EditSlide")",
                        type: 'Post',
                        data: values,
                        beforeSend: function() {
                            $("#loading").css("display", "block");
                        },
                        success: function(result) {
                            if (result.status === "success") {
                                list();
                                Swal.fire({
                                    type: 'success',
                                    title: result.message,
                                    confirmButtonText:
                                        '<i class="fa fa-thumbs-up"></i> متوجه شدم!',
                                });
                                $('#add').collapse('hide');
                                clearForm("#addSlide");
                                $(".ImageWrapper img").attr("src", "/images/blank.png");
                                picSrc = "";
                            } else if (result.status === "error") {
                                if (spanErrorList.length > 1) {
                                    spanErrorList.each(function() {
                                        $(this).html("");
                                        $(this).parent().removeClass("has-error");
                                    });
                                }
                                if (result.modelStateErrors !== null) {

                                    result.modelStateErrors.forEach(function(value, index) {
                                        $("#addSlide").find('[data-val-result=' + value.key + ']')
                                            .html(value.errorMessage);
                                        $("#addSlide").find('[data-val-result=' + value.key + ']').parent()
                                            .addClass("has-error");
                                    });
                                } else {
                                    Swal.fire({
                                        type: 'error',
                                        title: result.message,
                                        confirmButtonText:
                                            '<i class="fa fa-thumbs-up"></i> متوجه شدم!',
                                    });
                                }
                            }

                        },
                        error: function(xhr, ajaxOptions, thrownError) {

                        },
                        complete: function() {
                            $("#loading").css("display", "none");
                        }
                    });
                }
            });

            $(document).on("click", "#editRecord",
                function(e) {
                    e.preventDefault();

                    var id = $(this).data("id");
                    var data = { slideId: id };

                    $.ajax({
                        url: "@Url.Action("GetSlide")",
                        type: 'Get',
                        data: data,
                        beforeSend: function() {
                            $("#loading").css("display", "block");
                        },
                        success: function(result) {

                            if (result.status === "success") {
                                var slide = result.data;

                                $("#addSlide #Title").val(slide.title);
                                $("#addSlide #Id").val(slide.id);
                                $("#addSlide #ColoredBackground").val(slide.coloredBackground);
                                $("#addSlide #ImageFit").val(slide.imageFit);
                                $("#addSlide #TransActionType").val(slide.transActionType);
                                $("#addSlide #Link").val(slide.link);
                                $("#addSlide #Target").val(slide.target);
                                $("#addSlide #Alt").val(slide.alt);
                                $(".ImageWrapper img").attr("src", slide.imageUrl);
                                picSrc = slide.imageUrl;

                                //$("#addSlide #StartDate").val(slide.startDate);
                                //$("#addSlide #ExpireDate").val(slide.expireDate);

                                if (slide.startDate !== "") {
                                    $('#calenderStart').MdPersianDateTimePicker('setDate', new Date(slide.startDate));
                                }
                                if (slide.expireDate !== null) {
                                    $('#calenderEnd').MdPersianDateTimePicker('setDate', new Date(slide.expireDate));
                                }

                                $('#add').collapse('show');

                            } else {
                                toastr.error(result.message);
                            }

                            $("#loading").css("display", "none");
                        },
                        error: function(xhr, ajaxOptions, thrownError) {
                            $("#loading").css("display", "none");
                        },
                        complete: function() {

                        }
                    });
                });
        });

        $(document).on("click", "#deleteRecord", function(e) {
            e.preventDefault();
            var id = $(this).data("id");

            $("#delete").data("id", id);
            $("#removeModal").modal("show");

        });

        $(document).on("click", "#delete", function(e) {
            e.preventDefault();
            var id = $(this).data("id");
            var data = { Id: id };

            $.ajax({
                url: "@Url.Action("DeleteSlide")",
                type: 'Get',
                data: data,
                beforeSend: function() {
                    $("#loading").css("display", "block");
                },
                success: function(result) {

                    if (result.status === "success") {
                        //var $inputs = $('#filter :input');

                        //var values1 = {};

                        //$inputs.each(function () {
                        //    values1[this.name] = $(this).val();
                        //});
                        //values1['PageSize'] = pageSize;
                        //values1['CurrentPage'] = $pagination.twbsPagination('getCurrentPage');

                        //list(values1);

                        $("#removeModal").modal("hide");
                        location.reload();
                        Swal.fire({
                            type: 'success',
                            title: result.message,
                            confirmButtonText:
                                '<i class="fa fa-thumbs-up"></i> متوجه شدم!',
                        });

                    } else {
                        Swal.fire({
                            type: 'error',
                            title: result.message,
                            confirmButtonText:
                                '<i class="fa fa-thumbs-up"></i> متوجه شدم!',
                        });
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {

                },
                complete: function() {
                    $("#loading").css("display", "none");
                }
            });
        });

        $(document).on("click", "#active", function (e) {
            var active;
            if (event.target.checked === true) {
                active = true;
            } else active = false;

            var elm = $(this);
            var id = $(this).data("id");
            var data = { Id: id, IsActive: active };

            $.ajax({
                url: "@Url.Action("ChangeBeActiveSlide")",
                type: 'Get',
                data: data,
                beforeSend: function() {
                    $("#loading").css("display", "block");
                },
                success: function(result) {

                    if (result.status === "success") {

                        var card = elm.parent().parent().parent().parent();

                        if (active === true) {
                            $(card).removeClass("notActive");
                            $(card).addClass("active");

                        } else {
                            $(card).removeClass("active");
                            $(card).addClass("notActive");
                        }

                        toastr.success(result.message);

                    } else {
                        elm.prop("checked", !active).change();
                        toastr.error(result.message);
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    elm.prop("checked", !active).change();
                },
                complete: function() {
                    $("#loading").css("display", "none");
                }
            });
        });

        function list() {
            $("#table").html("");
            var data = {
                pageSize: pageSize,
                currentPage: $pagination.twbsPagination('getCurrentPage'),
                sliderId: "@(ViewBag.SliderId)"
            };

            $.ajax({
                url: "@Url.Action("ListSlides")",
                type: 'Post',
                data: data,
                beforeSend: function() {
                    $("#loading-data").css("display", "block");
                },
                success: function(result) {

                    $("#table").html(result);

                    var totalPages = $("#page-data").data("total");
                    var currentPage = $pagination.twbsPagination('getCurrentPage');

                    $pagination.twbsPagination('destroy');

                    if (totalPages > 0) {
                        $pagination.twbsPagination($.extend({},
                            defaultOpts,
                            {
                                startPage: currentPage,
                                totalPages: totalPages
                            }));
                    }
                },
                error: function(xhr, ajaxOptions, thrownError) {
                },
                complete: function() {
                    $("#loading-data").css("display", "none");
                    $("#loading").css("display", "none");
                }
            });
        }

        function clearForm(form) {
            $(form).find(':input').each(function () {
                switch (this.type) {
                case 'password':
                case 'text':
                case 'textarea':
                case 'hidden':
                {
                    $(this).val('');
                    break;
                }

                case 'checkbox':
                case 'radio':
                    this.checked = false;
                }
            });
        }
    </script>
}
*@